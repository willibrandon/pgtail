# Data Model: Nuitka Migration for Binary Distribution

**Feature Branch**: `020-nuitka-migration`
**Date**: 2026-01-01

## Overview

This feature does not introduce persistent data entities. It modifies the build system and distribution artifacts. The "data model" here describes the structure of build artifacts and configuration files.

---

## 1. Build Artifacts

### 1.1 Nuitka Standalone Output

```
Entity: NuitkaDistribution
Description: A compiled Nuitka standalone distribution folder
```

| Field | Type | Description |
|-------|------|-------------|
| `platform` | string | Target OS: `macos`, `linux`, `windows` |
| `arch` | string | CPU architecture: `arm64`, `x86_64` |
| `executable` | file | Main executable: `pgtail` or `pgtail.exe` |
| `dependencies` | directory | Runtime libraries and packages |
| `certifi` | directory | CA certificate bundle (cacert.pem) |

**Naming Convention**: `pgtail-{platform}-{arch}/`

**Examples**:
- `pgtail-macos-arm64/pgtail`
- `pgtail-linux-x86_64/pgtail`
- `pgtail-windows-x86_64/pgtail.exe`

### 1.2 Release Archives

```
Entity: ReleaseArchive
Description: Compressed distribution for download
```

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | Archive filename |
| `format` | enum | `tar.gz` (Unix) or `zip` (Windows) |
| `contents` | NuitkaDistribution | Nested folder with executable |
| `sha256` | string | SHA256 checksum |

**Unix Archives (tar.gz)**:
```
pgtail-macos-arm64.tar.gz
└── pgtail-macos-arm64/
    ├── pgtail (executable)
    ├── libpython3.12.so (or similar)
    ├── certifi/cacert.pem
    └── ... (dependencies)
```

**Windows Archives (zip + msi)**:
```
pgtail-windows-x86_64.zip
└── pgtail-windows-x86_64/
    ├── pgtail.exe
    ├── python312.dll
    └── ... (dependencies)

pgtail-windows-x86_64.msi (WiX installer)
```

---

## 2. Configuration Entities

### 2.1 Nuitka Build Configuration

```
Entity: NuitkaBuildConfig
Description: Command-line flags for Nuitka compilation
```

| Flag | Value | Required |
|------|-------|----------|
| `--mode` | `standalone` | Yes |
| `--output-dir` | `dist` | Yes |
| `--output-filename` | `pgtail` | Yes |
| `--include-package` | `pgtail_py`, `psutil` | Yes |
| `--include-package-data` | `certifi` | Yes |
| `--include-module` | Platform-specific modules | Yes |
| `--python-flag` | `no_asserts` | Optional |
| `--assume-yes-for-downloads` | (flag) | CI only |

### 2.2 WiX MSI Configuration

```
Entity: WixMsiConfig
Description: Windows MSI installer metadata
```

| Field | Type | Value |
|-------|------|-------|
| `UpgradeCode` | GUID | `F8E7D6C5-B4A3-9281-7654-321098FEDCBA` (constant) |
| `ProductName` | string | `pgtail` |
| `Manufacturer` | string | `willibrandon` |
| `InstallScope` | enum | `perMachine` |
| `InstallDir` | path | `Program Files\pgtail\` |
| `PathAction` | string | Append to system PATH |

### 2.3 winget Manifest Configuration

```
Entity: WingetManifest
Description: Windows Package Manager manifest files
```

| File | Type | Purpose |
|------|------|---------|
| `willibrandon.pgtail.yaml` | version | Version and identifier |
| `willibrandon.pgtail.installer.yaml` | installer | MSI URL, SHA256, ProductCode |
| `willibrandon.pgtail.locale.en-US.yaml` | locale | Description, tags, license |

**Key Fields**:
| Field | Value |
|-------|-------|
| `PackageIdentifier` | `willibrandon.pgtail` |
| `InstallerType` | `msi` |
| `ProductCode` | `{<auto-generated by WiX per version>}` |
| `ManifestVersion` | `1.9.0` |

**Note**: ProductCode MUST be extracted from the built MSI for each release (use `wix msi info` or similar). It changes per version.

### 2.4 Homebrew Formula Configuration

```
Entity: HomebrewFormula
Description: Ruby formula for Homebrew installation
```

| Field | Type | Description |
|-------|------|-------------|
| `version` | string | Release version (e.g., `0.2.0`) |
| `url` | string | Platform-specific tar.gz URL |
| `sha256` | string | Per-platform checksum |
| `install_path` | path | `libexec/` (private) with symlink to `bin/` |

---

## 3. Version Metadata

### 3.1 Version Fallback Entity

```
Entity: VersionFallback
Description: Hardcoded version for compiled binaries
Location: pgtail_py/__init__.py
```

```python
__version__ = "0.2.0"  # Synchronized with pyproject.toml
```

**Validation Rules**:
- Must match `pyproject.toml` version before each release
- Updated as part of release process

---

## 4. CI/CD Entities

### 4.1 Platform Matrix

```
Entity: PlatformMatrix
Description: Build configurations for GitHub Actions
```

| Platform | OS Runner | Architecture | Archive Format |
|----------|-----------|--------------|----------------|
| macOS ARM64 | `macos-14` | `arm64` | tar.gz |
| macOS x86_64 | `macos-15-intel` | `x86_64` | tar.gz |
| Linux x86_64 | `ubuntu-latest` | `x86_64` | tar.gz |
| Linux ARM64 | `ubuntu-24.04-arm` | `arm64` | tar.gz |
| Windows x86_64 | `windows-latest` | `x86_64` | zip + msi |

### 4.2 Release Artifacts

```
Entity: ReleaseArtifacts
Description: All files attached to a GitHub Release
```

| Artifact | Platforms |
|----------|-----------|
| `pgtail-macos-arm64.tar.gz` | macOS ARM64 |
| `pgtail-macos-arm64.tar.gz.sha256` | (checksum) |
| `pgtail-macos-x86_64.tar.gz` | macOS Intel |
| `pgtail-macos-x86_64.tar.gz.sha256` | (checksum) |
| `pgtail-linux-x86_64.tar.gz` | Linux x86_64 |
| `pgtail-linux-x86_64.tar.gz.sha256` | (checksum) |
| `pgtail-linux-arm64.tar.gz` | Linux ARM64 |
| `pgtail-linux-arm64.tar.gz.sha256` | (checksum) |
| `pgtail-windows-x86_64.zip` | Windows (portable) |
| `pgtail-windows-x86_64.zip.sha256` | (checksum) |
| `pgtail-windows-x86_64.msi` | Windows (winget) |
| `pgtail-windows-x86_64.msi.sha256` | (checksum) |

---

## 5. Entity Relationships

```
pyproject.toml
    └── version ────────────────────┐
                                    ▼
pgtail_py/__init__.py ──────► __version__ = "0.2.0"
                                    │
                                    ▼
Nuitka Build ──────────────► NuitkaDistribution
                                    │
         ┌──────────────────────────┼──────────────────────────┐
         ▼                          ▼                          ▼
    tar.gz Archive            zip Archive                WiX MSI
         │                          │                          │
         ▼                          ▼                          ▼
   GitHub Release            GitHub Release              GitHub Release
         │                          │                          │
         ▼                          │                          ▼
  Homebrew Formula                  │                   winget Manifest
                                    ▼
                              Manual Install
```

---

## 6. Validation Rules

### 6.1 Version Synchronization
- `pyproject.toml` version MUST equal `pgtail_py/__init__.py.__version__`
- Both MUST be updated before tagging a release

### 6.2 Archive Structure
- Archive MUST contain a single folder named `pgtail-{platform}-{arch}/`
- Folder MUST contain executable named `pgtail` (or `pgtail.exe` on Windows)

### 6.3 MSI Constraints
- UpgradeCode MUST remain constant: `F8E7D6C5-B4A3-9281-7654-321098FEDCBA`
- ProductCode MUST be auto-generated per build (use `Id="*"` in WiX source)
- ProductCode MUST be extracted from built MSI and included in winget manifest
- Version MUST use 4-part format: `X.Y.Z.0`
- Only first 3 parts used for upgrade detection

### 6.4 Checksum Requirements
- Every release artifact MUST have corresponding `.sha256` file
- Homebrew formula SHA256 MUST match downloaded archive
- winget manifest InstallerSha256 MUST match MSI file
